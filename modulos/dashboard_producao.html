<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Produ√ß√£o</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: #f4f6fa;
    display: flex;
  }
  .sidebar {
    width: 220px;
    background: #fff;
    height: 100vh;
    padding: 20px 10px;
    border-right: 1px solid #ddd;
    box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .sidebar h2 {
    margin: 0;
    font-size: 18px;
    color: #333;
    text-align: center;
  }
  .nav {
    margin-top: 30px;
  }
  .nav a {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    margin: 4px 0;
    border-radius: 8px;
    text-decoration: none;
    color: #333;
    transition: 0.2s;
  }
  .nav a:hover, .nav a.active {
    background-color: #e0edff;
    color: #1d4ed8;
  }
  .logout {
    background: #f87171;
    color: white;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    margin-top: 20px;
  }
  .logout:hover {
    background: #dc2626;
  }
  .main {
    flex: 1;
    padding: 30px;
  }
  .cards {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
  }
  .card {
    flex: 1;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  }
  .card h3 {
    font-size: 16px;
    color: #777;
    margin-bottom: 8px;
  }
  .card p {
    font-size: 24px;
    font-weight: 600;
    color: #1d4ed8;
  }
  button {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 20px;
  }
  button:hover {
    background: #2563eb;
  }
  table {
    width: 100%;
    background: #fff;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    margin-bottom: 30px;
  }
  th, td {
    padding: 12px 14px;
    text-align: left;
  }
  th {
    background-color: #f0f2f5;
  }
  tr:nth-child(even) {
    background-color: #fafafa;
  }
  .form-modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.3);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .form-box {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    width: 400px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }
  input, select {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  .progress-bar {
    background: #e5e7eb;
    border-radius: 8px;
    height: 10px;
    overflow: hidden;
  }
  .progress-inner {
    background: #3b82f6;
    height: 100%;
  }
  .badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    color: white;
    display: inline-block;
  }
  .andamento { background: #3b82f6; }
  .concluido { background: #10b981; }
  .atrasado { background: #ef4444; }
  
</style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h2>ERP System</h2>
      <div class="nav">
        <a href="dashboard_inventario.html" >üì¶ Invent√°rio</a>
        <a href="dashboard_producao.html"class="active">üè≠ Produ√ß√£o</a>
        <a href="dashboard_compras.html">üõí Compras</a>
        <a href="dashboard_projetos.html">üìÅ Projetos</a>
        <a href="dashboard_vendas.html">üí∞ Vendas</a>
        <a href="dashboard_clientes.html" >üë§ Clientes</a>
      </div>
      <div class="logout" onclick="logout()">üîì Logout</div>
    </div>
  </div>

  <div class="main">
    <h1>Gest√£o de Produ√ß√£o</h1>
    <p style="margin-top: -10px; color: #666;"></p>

    <div class="cards">
      <div class="card"><h3>Produ√ß√£o Mensal</h3><p id="producaoMensal">0 unidades</p></div>
      <div class="card"><h3>Ordens em Andamento</h3><p id="ordensAndamento">0</p></div>
      <div class="card"><h3>Ordens Conclu√≠das</h3><p id="ordensConcluidas">0</p></div>
    </div>

    <div style="text-align: center;">
      <button onclick="mostrarFormulario()">‚ûï Nova Ordem de Produ√ß√£o</button>
    </div>

    <div class="form-modal" id="formOrdem" style="display: none;">
  <div class="form-box">
    <h3>Nova Ordem de Produ√ß√£o</h3>
    <select id="produto"><option value="">Carregando produtos...</option></select>
    <input type="number" id="quantidade" placeholder="Quantidade">
    <input type="date" id="data_inicio">
    <input type="date" id="previsao">
    <button onclick="adicionarOrdem()">Salvar Ordem</button>
  </div>
</div>


    <div class="table-section">
      <h2>Ordens de Produ√ß√£o</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Data In√≠cio</th>
            <th>Previs√£o</th>
            <th>Progresso</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaProducao">
          <tr><td colspan="7">Sem ordens ainda.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://nnitvxhubovlyfxdeemf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uaXR2eGh1Ym92bHlmeGRlZW1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNjU4ODYsImV4cCI6MjA2Mzg0MTg4Nn0.fTwCna-UBzfLRlbJ2EkWwQeXuq5t3ORwfgbsfiUqejU'
    );

    async function carregarProdutos() {
  const { data: sessionData } = await supabase.auth.getSession();
  const userId = sessionData?.session?.user?.id;

  const { data, error } = await supabase
    .from('produtos')
    .select('id, nome')
    .eq('usuario_id', userId);

  const select = document.getElementById('produto');
  select.innerHTML = ""; // limpa op√ß√µes anteriores

  if (error || !data.length) {
    const opt = document.createElement('option');
    opt.textContent = "Nenhum produto encontrado";
    opt.disabled = true;
    select.appendChild(opt);
    return;
  }

  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.nome;
    select.appendChild(opt);
  });
}


    async function carregarProducao() {
  const { data, error } = await supabase.from('ordens_producao').select('*').order('data_inicio', { ascending: false });
  if (error) return alert('Erro ao carregar dados');
  const { data: produtos } = await supabase.from('produtos').select('id, nome');
  const nomes = Object.fromEntries(produtos.map(p => [p.id, p.nome]));

  const tabela = document.getElementById('tabelaProducao');
  let mensal = 0, andamento = 0, concluidas = 0;

  if (!data || data.length === 0) {
    tabela.innerHTML = '<tr><td colspan="7">Sem ordens ainda.</td></tr>';
  } else {
    tabela.innerHTML = data.map(o => {
      const inicioDate = new Date(o.data_inicio);
      const fimDate = new Date(o.previsao_conclusao);
      const hoje = new Date();

      const diasTotais = Math.ceil((fimDate - inicioDate) / (1000 * 60 * 60 * 24));
      const diasPassados = Math.floor((hoje - inicioDate) / (1000 * 60 * 60 * 24));
      let progresso = Math.round((diasPassados / diasTotais) * 100);


progresso = Math.max(0, Math.min(progresso, 100));


if (progresso >= 100) {
  const hojeLimpo = new Date(hoje);
  hojeLimpo.setHours(0, 0, 0, 0);
  const fimLimpo = new Date(fimDate);
  fimLimpo.setHours(0, 0, 0, 0);

  if (hojeLimpo <= fimLimpo) {
    progresso = 99; 
  }
}



      // Atualiza os contadores
      if (inicioDate.getMonth() === hoje.getMonth() && inicioDate.getFullYear() === hoje.getFullYear()) {
        mensal += o.qtd_produzir;
      }
      if (progresso >= 100) {
        concluidas++;
      } else {
        andamento++;
      }

      const fimDateSemHora = new Date(fimDate);
fimDateSemHora.setHours(0, 0, 0, 0);
const hojeSemHora = new Date(hoje);
hojeSemHora.setHours(0, 0, 0, 0);

let status = o.status;
if (status === 'pendente' && fimDateSemHora < hojeSemHora) {
  status = 'atrasado';
}


     return `<tr>
  <td>${o.id.slice(0, 6)}</td>
  <td>${nomes[o.produto_id] || '‚Äî'}</td>
  <td>${o.qtd_produzir}</td>
  <td>${inicioDate.toLocaleDateString()}</td>
  <td>${fimDate.toLocaleDateString()}</td>
  <td><div class="progress-bar"><div class="progress-inner" style="width: ${progresso}%"></div></div></td>
  <td><span class="${status}">${status}</span></td>
  <td>
    <button onclick="editarOrdem('${o.id}')">‚úèÔ∏è</button>
    <button onclick="eliminarOrdem('${o.id}')" style="background:#ef4444;">üóëÔ∏è</button>
  </td>
</tr>`;

    }).join('');
  }

  document.getElementById('producaoMensal').textContent = `${mensal} unidades`;
  document.getElementById('ordensAndamento').textContent = andamento;
  document.getElementById('ordensConcluidas').textContent = concluidas;
}


    async function adicionarOrdem() {
      const produto_id = document.getElementById('produto').value;
      const qtd = parseInt(document.getElementById('quantidade').value);
      const inicio = document.getElementById('data_inicio').value;
      const fim = document.getElementById('previsao').value;
      if (!produto_id || !qtd || !inicio || !fim) return alert('Preencha todos os campos.');

      const nova = {
        produto_id,
        qtd_produzir: qtd,
        data_inicio: inicio,
        previsao_conclusao: fim,
        progresso: 0,
        status: 'pendente'
      };

      const { error } = await supabase.from('ordens_producao').insert([nova]);
      if (error) return alert('Erro ao adicionar ordem: ' + error.message);
      alert('Ordem adicionada!');
      document.getElementById('formOrdem').style.display = 'none';
      carregarProducao();
    }

    function mostrarFormulario() {
  const modal = document.getElementById("formOrdem");
  modal.style.display = modal.style.display === "none" || modal.style.display === "" ? "flex" : "none";
}
async function eliminarOrdem(id) {
  if (!confirm("Tem certeza que deseja eliminar esta ordem?")) return;

  const { error } = await supabase.from('ordens_producao').delete().eq('id', id);
  if (error) return alert("Erro ao eliminar: " + error.message);

  alert("Ordem eliminada com sucesso!");
  carregarProducao();
}

async function editarOrdem(id) {
  const { data, error } = await supabase.from('ordens_producao').select('*').eq('id', id).single();
  if (error) return alert("Erro ao carregar ordem");

  document.getElementById('produto').value = data.produto_id;
  document.getElementById('quantidade').value = data.qtd_produzir;
  document.getElementById('data_inicio').value = data.data_inicio;
  document.getElementById('previsao').value = data.previsao_conclusao;

  // Mostra formul√°rio
  mostrarFormulario();

  // Substitui o bot√£o salvar por editar
  const botao = document.querySelector('#formOrdem button');
  botao.textContent = "Atualizar Ordem";
  botao.onclick = async () => {
    const novaQtd = parseInt(document.getElementById('quantidade').value);
    const novoInicio = document.getElementById('data_inicio').value;
    const novaPrevisao = document.getElementById('previsao').value;
    const novoProduto = document.getElementById('produto').value;

    const { error } = await supabase.from('ordens_producao').update({
      produto_id: novoProduto,
      qtd_produzir: novaQtd,
      data_inicio: novoInicio,
      previsao_conclusao: novaPrevisao
    }).eq('id', id);

    if (error) return alert("Erro ao atualizar: " + error.message);

    alert("Ordem atualizada!");
    document.getElementById("formOrdem").style.display = "none";
    carregarProducao();
  };
}

async function verificarEAdicionarProdutosConcluidos() {
  const { data: ordens, error } = await supabase
    .from('ordens_producao')
    .select('*')
    .eq('status', 'pendente');

  if (error || !ordens) return;

  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0); 

  for (const ordem of ordens) {
    const fim = new Date(ordem.previsao_conclusao);
    fim.setHours(0, 0, 0, 0); 

    if (hoje > fim) {

      

      // Adicionar produto ao invent√°rio
      const produto = await supabase.from('produtos').select('*').eq('id', ordem.produto_id).single();
      if (produto.error || !produto.data) continue;

      const existente = await supabase
        .from('produtos')
        .select('*')
        .eq('nome', produto.data.nome)
        .maybeSingle();

      if (existente.data) {
        // Atualiza a quantidade do produto existente
        await supabase
          .from('produtos')
          .update({ qtd: existente.data.qtd + ordem.qtd_produzir })
          .eq('id', existente.data.id);
      } else {
        // Cria novo produto com quantidade produzida
        await supabase.from('produtos').insert([{
          nome: produto.data.nome,
          categoria: produto.data.categoria,
          qtd: ordem.qtd_produzir,
          valor_unitario: produto.data.valor_unitario,
          status: 'ativo',
          usuario_id: produto.data.usuario_id
        }]);
      }

      // Atualiza status da ordem
      await supabase.from('ordens_producao').update({ status: 'conclu√≠do' }).eq('id', ordem.id);
    }
  }
}

window.addEventListener("click", function(e) {
  const modal = document.getElementById("formOrdem");
  if (e.target === modal) {
    modal.style.display = "none";
  }
});



    window.addEventListener('DOMContentLoaded', async () => {
  await carregarProdutos();
  await carregarProducao();
  await verificarEAdicionarProdutosConcluidos(); // üëà adiciona aqui
  setInterval(verificarEAdicionarProdutosConcluidos, 60000);
});

  </script>
</body>
</html>
